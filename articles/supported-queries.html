<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Supported Queries • salesforcer</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/spacelab/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Supported Queries">
<meta property="og:description" content="salesforcer">
<meta property="og:image" content="https://stevenmmortimer.github.io/salesforcer/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-98603021-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-98603021-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">salesforcer</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.2.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa fas fa-book"></span>
     
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/getting-started.html">Getting Started</a>
    </li>
    <li>
      <a href="../articles/supported-queries.html">Supported Queries</a>
    </li>
    <li>
      <a href="../articles/working-with-bulk-apis.html">Working with Bulk APIs</a>
    </li>
    <li>
      <a href="../articles/working-with-reports.html">Working with Reports</a>
    </li>
    <li>
      <a href="../articles/working-with-attachments.html">Working with Attachments</a>
    </li>
    <li>
      <a href="../articles/working-with-metadata.html">Working with Metadata</a>
    </li>
    <li>
      <a href="../articles/passing-control-args.html">Passing Control Args</a>
    </li>
    <li>
      <a href="../articles/transitioning-from-RForcecom.html">Transitioning from RForcecom</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-file-code-o"></span>
     
    Reference
  </a>
</li>
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    News
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/StevenMMortimer/salesforcer">
    <span class="fa fa-github fa-lg"></span>
     
    GitHub
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="supported-queries_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Supported Queries</h1>
                        <h4 class="author">Steven M. Mortimer</h4>
            
            <h4 class="date">2020-07-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/StevenMMortimer/salesforcer/blob/master/vignettes/supported-queries.Rmd"><code>vignettes/supported-queries.Rmd</code></a></small>
      <div class="hidden name"><code>supported-queries.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>The following vignette outlines the different types of queries that have been documented and tested. These are the “supported” query types that the {salesforcer} package currently handles. If you run into an issue, please submit the issue <a href="https://github.com/StevenMMortimer/salesforcer/issues/new?assignees=StevenMMortimer&amp;labels=&amp;template=query-issue-template.md&amp;title=">HERE</a> in the GitHub repository so that we can fix or add your query type to this list. Thank you!</p>
<p><strong>Note</strong>: Salesforce’s proprietary form of SQL called SOQL (Salesforce Object Query Language) is a powerful tool that allows you to return the fields of records in almost any object in Salesforce. This includes standard objects like Accounts, Contacts, and Tasks along with any custom objects and custom fields created in your Org. You are encouraged to use Bulk APIs when:</p>
<ul>
<li>You anticipate returning 10,000 records or more</li>
<li>Your query does not involve a parent-to-child nested relationship query</li>
<li>You would like to reduce the overall number of API calls to your Org</li>
</ul>
<p>If you are not familiar with SOQL, then please consider reading the following resources:</p>
<ul>
<li>
<a rel="noopener noreferrer" target="_blank" href="https://developer.salesforce.com/docs/atlas.en-us.soql_sosl.meta/soql_sosl/sforce_api_calls_soql_sosl_intro.htm">Introduction to SOQL and SOSL</a><br>
</li>
<li>
<a rel="noopener noreferrer" target="_blank" href="https://developer.salesforce.com/docs/atlas.en-us.soql_sosl.meta/soql_sosl/sforce_api_calls_soql_select.htm">SOQL SELECT Syntax</a><br>
</li>
<li>
<a rel="noopener noreferrer" target="_blank" href="https://developer.salesforce.com/docs/atlas.en-us.soql_sosl.meta/soql_sosl/sforce_api_calls_soql_relationships.htm">Relationship Queries</a><br>
</li>
<li><a rel="noopener noreferrer" target="_blank" href="https://developer.salesforce.com/docs/atlas.en-us.soql_sosl.meta/soql_sosl/async_query_overview.htm">Async SOQL</a></li>
<li><a rel="noopener noreferrer" target="_blank" href="https://developer.salesforce.com/docs/atlas.en-us.api_asynch.meta/api_asynch/asynch_api_bulk_query_intro.htm">Overview of queries in Bulk 1.0 API</a></li>
<li><a rel="noopener noreferrer" target="_blank" href="https://developer.salesforce.com/docs/atlas.en-us.api_bulk_v2.meta/api_bulk_v2/queries.htm">Overview of queries in Bulk 2.0 API</a></li>
</ul>
<hr>
</div>
<div id="authentication" class="section level2">
<h2 class="hasAnchor">
<a href="#authentication" class="anchor"></a>Authentication</h2>
<p>First, load the {salesforcer} package and login. There are two ways to authenticate: 1) OAuth 2.0 (SSO) and 2) Basic Username-Password. It is recommended to use OAuth 2.0 so that passwords do not have to be embedded in scripts or environment variables. By default, OAuth 2.0 stores the user’s credentials in a locally cached file entitled “.httr-oauth-salesforcer” in the current working directory and will be refreshed automatically when the session expires.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org">dplyr</a></span>, warn.conflicts = <span class="fl">FALSE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/StevenMMortimer/salesforcer">salesforcer</a></span>)
<span class="fu"><a href="../reference/sf_auth.html">sf_auth</a></span>()
</pre></div>
</div>
<div id="default-query-behavior" class="section level2">
<h2 class="hasAnchor">
<a href="#default-query-behavior" class="anchor"></a>Default query behavior</h2>
<p>The default API for the <code><a href="../reference/sf_query.html">sf_query()</a></code> function is the REST API because it is both fast and flexible. Every effort has been made so that the format of the results from the REST and SOAP APIs is exactly the same. The only difference will be speed. The REST API uses JSON, which can generally be processed more quickly than XML used in the SOAP API.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">soql</span> <span class="op">&lt;-</span> <span class="st">"SELECT Id,
                FirstName, 
                LastName
         FROM Contact
         LIMIT 10"</span>

<span class="kw">queried_records</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sf_query.html">sf_query</a></span>(<span class="kw">soql</span>) <span class="co"># REST API is the default api_type</span>
<span class="kw">queried_records</span>
<span class="co">#&gt; # A tibble: 10 x 3</span>
<span class="co">#&gt;   Id                 FirstName LastName        </span>
<span class="co">#&gt;   &lt;chr&gt;              &lt;chr&gt;     &lt;chr&gt;           </span>
<span class="co">#&gt; 1 0033s000013wlpjAAA Test      Contact-Create-1</span>
<span class="co">#&gt; 2 0033s000013wlpkAAA Test      Contact-Create-2</span>
<span class="co">#&gt; 3 0033s000014AG4HAAW Test      Contact-Create-1</span>
<span class="co">#&gt; 4 0033s0000149ZoCAAU Test      Contact-Create-1</span>
<span class="co">#&gt; 5 0033s0000149ZoDAAU Test      Contact-Create-2</span>
<span class="co">#&gt; # … with 5 more rows</span>

<span class="kw">queried_records</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sf_query.html">sf_query</a></span>(<span class="kw">soql</span>, api_type = <span class="st">"SOAP"</span>)
<span class="kw">queried_records</span>
<span class="co">#&gt; # A tibble: 10 x 3</span>
<span class="co">#&gt;   Id                 FirstName LastName        </span>
<span class="co">#&gt;   &lt;chr&gt;              &lt;chr&gt;     &lt;chr&gt;           </span>
<span class="co">#&gt; 1 0033s000013wlpjAAA Test      Contact-Create-1</span>
<span class="co">#&gt; 2 0033s000013wlpkAAA Test      Contact-Create-2</span>
<span class="co">#&gt; 3 0033s000014AG4HAAW Test      Contact-Create-1</span>
<span class="co">#&gt; 4 0033s0000149ZoCAAU Test      Contact-Create-1</span>
<span class="co">#&gt; 5 0033s0000149ZoDAAU Test      Contact-Create-2</span>
<span class="co">#&gt; # … with 5 more rows</span>
</pre></div>
</div>
<div id="rest-vs--soap-api-query-performance-test" class="section level2">
<h2 class="hasAnchor">
<a href="#rest-vs--soap-api-query-performance-test" class="anchor"></a>REST vs. SOAP API query performance test</h2>
<p>Below is a small example to roughly demonstrate the magnitude of the performance difference between the REST and SOAP APIs when querying 1,000 records.</p>
<p><strong>Setup performance test</strong></p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="co"># create a new account </span>
<span class="co"># (if replicating, you may or may not have an external id field in your Org)</span>
<span class="kw">prefix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"APerfTest-"</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">99999</span>)))
<span class="kw">new_account</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sf_create.html">sf_create</a></span>(
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(
    Name = <span class="st">"Test Account For Performance Test"</span>, 
    My_External_Id__c = <span class="kw">prefix</span>,
    Description = <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"This is a test account with 1,000 records for "</span>, 
                         <span class="st">"testing the performance differences between the "</span>, 
                         <span class="st">"SOAP and REST APIs."</span>)
  ), 
  object_name = <span class="st">"Account"</span>
)

<span class="co"># create and associate a thousand new contacts with that account</span>
<span class="co"># (again, you may or may not have an external id field in your Org)</span>
<span class="kw">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="kw">prefix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"CPerfTest-"</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">99999</span>)), <span class="st">"-"</span>)
<span class="kw">new_contacts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(FirstName = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"Test"</span>, <span class="kw">n</span>),
                       LastName = <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Query-Vignette"</span>, <span class="fl">1</span><span class="op">:</span><span class="kw">n</span>), 
                       test_number__c = <span class="fl">999.9</span>,
                       AccountId = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw">new_account</span><span class="op">$</span><span class="kw">id</span>, <span class="kw">n</span>),
                       My_External_Id__c=<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="kw">prefix</span>, <span class="fl">1</span><span class="op">:</span><span class="kw">n</span>))
<span class="kw">new_contacts_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sf_create.html">sf_create</a></span>(<span class="kw">new_contacts</span>, <span class="st">"Contact"</span>, api_type = <span class="st">"Bulk 2.0"</span>)
</pre></div>
<p><strong>Performance test</strong></p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">qry</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">api_type</span>){
  <span class="fu"><a href="../reference/sf_query.html">sf_query</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"SELECT Id, Name, Owner.Id, 
               (SELECT Id, LastName, Owner.Id FROM Contacts) 
            FROM Account
            WHERE Id = '%s'"</span>, 
            <span class="kw">new_account</span><span class="op">$</span><span class="kw">id</span>), 
    api_type = <span class="kw">api_type</span>
  )
}
<span class="kw">res</span> <span class="op">&lt;-</span> <span class="kw">microbenchmark</span>::<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span>(
  <span class="fu">qry</span>(<span class="st">"REST"</span>),
  <span class="fu">qry</span>(<span class="st">"SOAP"</span>),
  times = <span class="fl">5</span>, 
  unit = <span class="st">"s"</span>
)
<span class="kw">res</span>
<span class="co">#&gt; Unit: seconds</span>
<span class="co">#&gt;         expr       min        lq      mean    median        uq       max neval</span>
<span class="co">#&gt;  qry("REST")  3.907048  3.970231  4.078336  4.028972  4.073535  4.411894     5</span>
<span class="co">#&gt;  qry("SOAP") 18.448496 18.553716 19.126748 18.724751 18.861404 21.045371     5</span>

<span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span>(
  <span class="kw">ggplot2</span>::<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span>(<span class="kw">res</span>) <span class="op">+</span> 
    <span class="kw">ggplot2</span>::<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(name=<span class="st">"Time [seconds]"</span>, n.breaks=<span class="fl">6</span>)
))
</pre></div>
<p><img src="supported-queries_files/figure-html/run-performance-test-1.png" width="700"></p>
<p>As seen in the limited test above, the REST API can be anywhere from <strong>4-6x</strong> faster than the SOAP API for a query on 1,000 contact records associated with a single Account. Breaking up the number of records returned into smaller batches by setting <code>QueryOptions = list(batchSize = 200)</code> typically does not affect this result very much but it also depends on the number of fields in the query. For the REST API the default is 2,000 records per batch with a minimum of 200 and maximum of 2,000. For the SOAP API the default is 500 records per batch. For both APIs it is important to note that there is no guarantee that the requested batch size is the actual batch size. Changes are made as necessary to maximize performance. For example, the SOAP API states “batch size will be no more than 200 if the SOQL statement selects two or more custom fields of type long text”. The REST API mentions that the limit imposed by Salesforce’s app servers is around 20,000 characters which can cause batches to be smaller. In short, it’s generally okay to use the default batch sizes since Salesforce may optimize over your specified batch size anyways.</p>
</div>
<div id="when-to-use-the-bulk-apis-for-queries" class="section level2">
<h2 class="hasAnchor">
<a href="#when-to-use-the-bulk-apis-for-queries" class="anchor"></a>When to use the Bulk APIs for queries</h2>
<p>A general rule of thumb for using the Bulk APIs (Bulk 1.0 and Bulk 2.0) for queries is anytime you need to retrieve more than 10,000 records. The main reasons to not use the Bulk APIs are twofold. First, they do not support complex relationship queries or aggregate queries. If you need to write a nested relationship or aggregate query involving a large number of records you may be tempted to use the REST API. However, it is recommended to perform two or more separate bulk queries that retrieve the records you need and then join or aggregate the results in R.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="co"># nested relationship query </span>
<span class="co"># (supposed to return the id and first name of all contacts on each account)</span>
<span class="fu"><a href="https://rdrr.io/r/base/try.html">try</a></span>(
  <span class="fu"><a href="../reference/sf_query.html">sf_query</a></span>(
    <span class="st">"SELECT Id, Name, 
      (SELECT Id, FirstName FROM Contacts)
    FROM Account"</span>,
    api_type = <span class="st">"Bulk 2.0"</span>
  )
)
<span class="co">#&gt; Request failed [400]. Retrying in 1.5 seconds...</span>
<span class="co">#&gt; Request failed [400]. Retrying in 2.7 seconds...</span>
<span class="co">#&gt; Error : API_ERROR: Aggregate Relationships not supported in Bulk V2 Query with CSV content type</span>

<span class="co"># aggregate query</span>
<span class="co"># (supposed to return the count of contacts per account)</span>
<span class="fu"><a href="https://rdrr.io/r/base/try.html">try</a></span>(
  <span class="fu"><a href="../reference/sf_query.html">sf_query</a></span>(
    <span class="st">"SELECT Account.Id, Count(Name) contacts_n
    FROM Contact
    GROUP BY Account.Id"</span>,  
    api_type = <span class="st">"Bulk 2.0"</span>
  )
)
<span class="co">#&gt; Request failed [400]. Retrying in 1 seconds...</span>
<span class="co">#&gt; Request failed [400]. Retrying in 1 seconds...</span>
<span class="co">#&gt; Error : API_ERROR: Aggregate Relationships not supported in Bulk Query</span>
</pre></div>
<p>The two queries above were trying to pull all the contacts for each account and then get a count of how many contacts there are per account. If you have a lot of records, using the REST API to return these results may not be feasible. Even though the Bulk APIs cannot handle the same query, they can pull down massive amounts of data quickly. In this case you can pull down all of the Contact records and all of the Account records and then perform the calculation using <strong>dplyr</strong>, like so:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="kw">contacts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sf_query.html">sf_query</a></span>(<span class="st">"SELECT Id, FirstName, Account.Id
                     FROM Contact"</span>, 
                     api_type = <span class="st">"Bulk 2.0"</span>)

<span class="kw">accounts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sf_query.html">sf_query</a></span>(<span class="st">"SELECT Id, Name 
                     FROM Account"</span>, 
                     api_type = <span class="st">"Bulk 2.0"</span>)

<span class="kw">nested_query_recs</span> <span class="op">&lt;-</span> <span class="kw">accounts</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="kw">contacts</span> <span class="op">%&gt;%</span> 
              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span>(`Contact.Id` = <span class="kw">Id</span>, 
                     `Contact.FirstName` = <span class="kw">FirstName</span>), 
            by = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Id"</span> = <span class="st">"Account.Id"</span>))
<span class="kw">nested_query_recs</span>
<span class="co">#&gt; # A tibble: 1,315 x 4</span>
<span class="co">#&gt;   Id              Name                         Contact.Id       Contact.FirstNa…</span>
<span class="co">#&gt;   &lt;chr&gt;           &lt;chr&gt;                        &lt;chr&gt;            &lt;chr&gt;           </span>
<span class="co">#&gt; 1 0013s00000zFdu… KEEP Test Account With Chil… 0033s000012Nkzw… KEEP            </span>
<span class="co">#&gt; 2 0013s00000zFdu… KEEP Test Account With Chil… 0033s000012Nkzx… KEEP            </span>
<span class="co">#&gt; 3 0013s00000zFdu… KEEP Test Account With Chil… 0033s000012Nkzy… KEEP            </span>
<span class="co">#&gt; 4 0013s00000zFdu… KEEP Test Account With Chil… 0033s000012Nkzz… KEEP            </span>
<span class="co">#&gt; 5 0013s00000zFdu… KEEP Test Account With Chil… 0033s000012Nl00… KEEP            </span>
<span class="co">#&gt; # … with 1,310 more rows</span>

<span class="kw">aggregate_query_recs</span> <span class="op">&lt;-</span> <span class="kw">nested_query_recs</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="kw">Id</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(.groups = <span class="st">'drop'</span>, 
            contacts_n = <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">Contact.Id</span>)))
<span class="kw">aggregate_query_recs</span>
<span class="co">#&gt; # A tibble: 12 x 2</span>
<span class="co">#&gt;   Id                 contacts_n</span>
<span class="co">#&gt;   &lt;chr&gt;                   &lt;int&gt;</span>
<span class="co">#&gt; 1 0013s00000zFdugAAC        300</span>
<span class="co">#&gt; 2 0013s00000zFgA6AAK          0</span>
<span class="co">#&gt; 3 0013s000011K0xmAAC        999</span>
<span class="co">#&gt; 4 0016A0000035mJ4QAI          2</span>
<span class="co">#&gt; 5 0016A0000035mJ5QAI          1</span>
<span class="co">#&gt; # … with 7 more rows</span>
</pre></div>
<p>The second reason to not use the Bulk APIs is that there is a performance overhead associated with every bulk (asynchronous) job that involves checking the status of the job until it succeeds or fails before retrieving the results.</p>
<p>The example below is provided so that you can take this code as an example to run your own performance test of queries that return 10K, 100K, 1M+ records to see where the Bulk APIs outperform the REST API.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="kw">qry_compare</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">api_type</span>){
  <span class="kw">soql</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"SELECT Id, LastName, Account.Id, Account.Name, Owner.Id
                   FROM Contact
                   WHERE Account.Id = '%s'"</span>, 
                   <span class="kw">new_account</span><span class="op">$</span><span class="kw">id</span>)
  <span class="fu"><a href="../reference/sf_query.html">sf_query</a></span>(<span class="kw">soql</span>, api_type = <span class="kw">api_type</span>)
}

<span class="kw">res</span> <span class="op">&lt;-</span> <span class="kw">microbenchmark</span>::<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span>(
  <span class="fu">qry_compare</span>(<span class="st">"REST"</span>),
  <span class="fu">qry_compare</span>(<span class="st">"Bulk 1.0"</span>),
  <span class="fu">qry_compare</span>(<span class="st">"Bulk 2.0"</span>),
  times = <span class="fl">5</span>, 
  unit = <span class="st">"s"</span>
)
</pre></div>
<p>Note that the Bulk 1.0 API requires users to specify the target object along with their submitted SOQL. This is because it is needed when creating the bulk job that will manage and execute the query.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="kw">queried_records</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sf_query.html">sf_query</a></span>(<span class="kw">soql</span>, api_type = <span class="st">"Bulk 1.0"</span>)
<span class="co">#&gt; Guessed 'Contact' as the object_name from supplied SOQL.</span>
<span class="co">#&gt; Please set `object_name` explicitly if this is incorrect because it is required by the Bulk APIs.</span>
</pre></div>
<p>As you can see above the {salesforcer} package will try to infer the object in the query if not explicitly provided. If it does not guess correctly, then please specify.</p>
<p><strong>Cleanup after performance tests</strong></p>
<p>By keeping track of the account ids used in our tests, it is fairly easy to find and delete these test records from our Org to save space.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="co"># cleanup performance test Contact records ...</span>
<span class="kw">contacts_to_delete</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sf_query.html">sf_query</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"SELECT Id 
          FROM Contact 
          WHERE Account.Id = '%s'"</span>,
          <span class="kw">new_account</span><span class="op">$</span><span class="kw">id</span>)
)
<span class="fu"><a href="../reference/sf_delete.html">sf_delete</a></span>(<span class="kw">contacts_to_delete</span><span class="op">$</span><span class="kw">Id</span>, <span class="st">"Contact"</span>, api_type=<span class="st">"Bulk 2.0"</span>)
<span class="co">#&gt; # A tibble: 999 x 4</span>
<span class="co">#&gt;   Id                 sf__Id             sf__Created sf__Error</span>
<span class="co">#&gt;   &lt;chr&gt;              &lt;chr&gt;              &lt;lgl&gt;       &lt;lgl&gt;    </span>
<span class="co">#&gt; 1 0033s000014B3XAAA0 0033s000014B3XAAA0 FALSE       NA       </span>
<span class="co">#&gt; 2 0033s000014B3XBAA0 0033s000014B3XBAA0 FALSE       NA       </span>
<span class="co">#&gt; 3 0033s000014B3WxAAK 0033s000014B3WxAAK FALSE       NA       </span>
<span class="co">#&gt; 4 0033s000014B3WyAAK 0033s000014B3WyAAK FALSE       NA       </span>
<span class="co">#&gt; 5 0033s000014B3WzAAK 0033s000014B3WzAAK FALSE       NA       </span>
<span class="co">#&gt; # … with 994 more rows</span>

<span class="co"># ... and finally delete the account</span>
<span class="fu"><a href="../reference/sf_delete.html">sf_delete</a></span>(<span class="kw">new_account</span><span class="op">$</span><span class="kw">id</span>)
<span class="co">#&gt; # A tibble: 1 x 2</span>
<span class="co">#&gt;   id                 success</span>
<span class="co">#&gt;   &lt;chr&gt;              &lt;lgl&gt;  </span>
<span class="co">#&gt; 1 0013s000011K0xmAAC TRUE</span>
</pre></div>
</div>
<div id="relationship-queries" class="section level2">
<h2 class="hasAnchor">
<a href="#relationship-queries" class="anchor"></a>Relationship queries</h2>
<p>Salesforce supports retrieving fields from related objects when querying another object. This is similar to performing a JOIN in SQL, but without having to specify the join keys because Salesforce already knows the relationship between the two objects. There are two types of relationship queries (1. child-to-parent lookups and 2. parent-to-child nested queries) detailed in the sections below.</p>
<div id="child-to-parent-lookup-queries" class="section level3">
<h3 class="hasAnchor">
<a href="#child-to-parent-lookup-queries" class="anchor"></a>child-to-parent “lookup” queries</h3>
<p>The first type of relationship query and the most common is child to parent. For example, the Contact object (child) to their parent, the Account object. In order to pull down parent object fields with your child record query, you just need to prefix any fields from the related object by concatenating the name of the object with the field name separated by a period. In the example below we are retrieving all Contact object records that have a relationship to an Account.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="co"># child-to-parent relationship (e.g. Account.Name from Contact record)</span>
<span class="fu"><a href="../reference/sf_query.html">sf_query</a></span>(
  <span class="st">"SELECT Id, FirstName, Account.Name
  FROM Contact
  WHERE Account.Id != null"</span>
)
<span class="co">#&gt; # A tibble: 315 x 3</span>
<span class="co">#&gt;   Id                 FirstName Account.Name                   </span>
<span class="co">#&gt;   &lt;chr&gt;              &lt;chr&gt;     &lt;chr&gt;                          </span>
<span class="co">#&gt; 1 0036A000002C6MWQA0 Rose      Edge Communications            </span>
<span class="co">#&gt; 2 0036A000002C6MXQA0 Sean      Edge Communications            </span>
<span class="co">#&gt; 3 0036A000002C6MfQAK Babara    Express Logistics and Transport</span>
<span class="co">#&gt; 4 0036A000002C6MgQAK Josh      Express Logistics and Transport</span>
<span class="co">#&gt; 5 0036A000002C6MhQAK Jane      University of Arizona          </span>
<span class="co">#&gt; # … with 310 more rows</span>
</pre></div>
<p>Sometimes you may notice that the requested relationship fields do not appear in the query results. This is because the SOAP and REST APIs do not return any related object information if it does not exist on the record and there is no reliable way to extract and rebuild the empty columns based on the query string. In the example below, if there were Account information an additional column titled <code>"Account.Name"</code> would appear in the results.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="co"># child-to-parent relationship (e.g. Account.Name from Contact record)</span>
<span class="fu"><a href="../reference/sf_query.html">sf_query</a></span>(
  <span class="st">"SELECT Id, FirstName, Account.Name
  FROM Contact
  WHERE Account.Id = null"</span>
)
<span class="co">#&gt; # A tibble: 592 x 2</span>
<span class="co">#&gt;   Id                 FirstName</span>
<span class="co">#&gt;   &lt;chr&gt;              &lt;chr&gt;    </span>
<span class="co">#&gt; 1 0033s000013wlpjAAA Test     </span>
<span class="co">#&gt; 2 0033s000013wlpkAAA Test     </span>
<span class="co">#&gt; 3 0033s000014AG4HAAW Test     </span>
<span class="co">#&gt; 4 0033s0000149ZoCAAU Test     </span>
<span class="co">#&gt; 5 0033s0000149ZoDAAU Test     </span>
<span class="co">#&gt; # … with 587 more rows</span>
</pre></div>
<p>Note, that the Bulk 1.0 and Bulk 2.0 APIs will return <code>"Account.Name"</code> as a column of all <code>NA</code> values for this query because they return results differently.</p>
<p>Finally, one aspect to note is that the Bulk 2.0 API does not support child-to-parent-grandparent relationships as seen in the example below:</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/try.html">try</a></span>(
  <span class="fu"><a href="../reference/sf_query.html">sf_query</a></span>(<span class="st">"SELECT Id, FirstName, Account.Owner.Id
            FROM Contact"</span>, 
           api_type = <span class="st">"Bulk 2.0"</span>)
)
<span class="co">#&gt; Error in sf_query_bulk_v2(soql = soql, object_name = object_name, queryall = queryall,  : </span>
<span class="co">#&gt;   Failure during batch processing: FeatureNotEnabled : Cannot serialize value for 'Owner' in CSV format</span>
</pre></div>
</div>
<div id="parent-to-child-nested-queries" class="section level3">
<h3 class="hasAnchor">
<a href="#parent-to-child-nested-queries" class="anchor"></a>parent-to-child “nested” queries</h3>
<p>Instead of “looking up” a related field, users can write queries that retrieve the individual records related to a parent. For example, if you would like all of the Accounts and their Contacts you can write the query like so:</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="fu"><a href="../reference/sf_query.html">sf_query</a></span>(
  <span class="st">"SELECT Id, Name, 
    (SELECT Id, FirstName FROM Contacts)
  FROM Account"</span>
)
<span class="co">#&gt; # A tibble: 316 x 4</span>
<span class="co">#&gt;   Id              Name                         Contact.FirstName Contact.Id     </span>
<span class="co">#&gt;   &lt;chr&gt;           &lt;chr&gt;                        &lt;chr&gt;             &lt;chr&gt;          </span>
<span class="co">#&gt; 1 0013s00000zFgA… KEEP Test Account With Chil… &lt;NA&gt;              &lt;NA&gt;           </span>
<span class="co">#&gt; 2 0013s00000zFdu… KEEP Test Account With Chil… KEEP              0033s000012Nl0…</span>
<span class="co">#&gt; 3 0013s00000zFdu… KEEP Test Account With Chil… KEEP              0033s000012Nkz…</span>
<span class="co">#&gt; 4 0013s00000zFdu… KEEP Test Account With Chil… KEEP              0033s000012Nkz…</span>
<span class="co">#&gt; 5 0013s00000zFdu… KEEP Test Account With Chil… KEEP              0033s000012Nkz…</span>
<span class="co">#&gt; # … with 311 more rows</span>
</pre></div>
<p>At first glance this query may appear the same as a lookup query on the Contact object that includes the account id and name. However, the small difference is that every Account is included, regardless of whether or not they have a Contact. This can be helpful when you want to ensure a query contains all of the parent records and their child records, if they exist. Also, note that the plural object name is used inside the nested query (“Contacts” instead of “Contact”).</p>
<p>Finally, a parent-to-child nested query can also contain a child-to-parent lookup relationship within it. Below is an example where the Owner Id on the Contact is included so you can know who is responsible for the Contacts under each Account.</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="fu"><a href="../reference/sf_query.html">sf_query</a></span>(
  <span class="st">"SELECT Name, Owner.Id, 
    (SELECT Id, FirstName, Owner.Id FROM Contacts)
   FROM Account"</span>
)
<span class="co">#&gt; # A tibble: 316 x 5</span>
<span class="co">#&gt;   Name              Contact.FirstName Contact.Id    Contact.Owner.Id Owner.Id   </span>
<span class="co">#&gt;   &lt;chr&gt;             &lt;chr&gt;             &lt;chr&gt;         &lt;chr&gt;            &lt;chr&gt;      </span>
<span class="co">#&gt; 1 KEEP Test Accoun… &lt;NA&gt;              &lt;NA&gt;          &lt;NA&gt;             0056A00000…</span>
<span class="co">#&gt; 2 KEEP Test Accoun… KEEP              0033s000012N… 0056A000000MPRj… 0056A00000…</span>
<span class="co">#&gt; 3 KEEP Test Accoun… KEEP              0033s000012N… 0056A000000MPRj… 0056A00000…</span>
<span class="co">#&gt; 4 KEEP Test Accoun… KEEP              0033s000012N… 0056A000000MPRj… 0056A00000…</span>
<span class="co">#&gt; 5 KEEP Test Accoun… KEEP              0033s000012N… 0056A000000MPRj… 0056A00000…</span>
<span class="co">#&gt; # … with 311 more rows</span>
</pre></div>
</div>
</div>
<div id="troubleshooting" class="section level2">
<h2 class="hasAnchor">
<a href="#troubleshooting" class="anchor"></a>Troubleshooting</h2>
<p>If you are having an issue with a query please submit in the {salesforcer} GitHub repository at: <a rel="noopener noreferrer" target="_blank" href="https://github.com/StevenMMortimer/salesforcer/issues">https://github.com/StevenMMortimer/salesforcer/issues</a>. As a maintainer, queries are tough to debug because every Salesforce Org is unique. Custom objects or relationships created in your Salesforce Org may be different or even impossible to test in another Org. When filing your issue please make an attempt to understand the query and debug a little bit on your own. Here are a few suggestions:</p>
<ol style="list-style-type: decimal">
<li>
<p>Slightly modify your function call to <code><a href="../reference/sf_query.html">sf_query()</a></code> to observe the results. Here are a few prompting questions that may assist you:</p>
<ul>
<li><p>What do you see when you set <code>verbose=TRUE</code> argument?</p></li>
<li><p>What happens if you change the <code>control</code> argument, specifically the batch size?</p></li>
<li><p>What happens if you try using a different API (e.g. “SOAP” vs “REST” or “Bulk 1.0” vs “Bulk 2.0”)?</p></li>
<li><p>What happens if you change your query slightly?</p></li>
<li><p>Do you need a parent-to-child nested relationship query or will a child-to-parent lookup suffice?</p></li>
</ul>
</li>
<li><p>Check out Salesforce’s <a href="https://workbench.developerforce.com/login.php">Workbench</a> tool to see how it builds out queries.</p></li>
<li><p>Double check Salesforce’s <a rel="noopener noreferrer" target="_blank" href="https://developer.salesforce.com/docs/atlas.en-us.soql_sosl.meta/soql_sosl/sforce_api_calls_soql.htm">SOQL reference guide</a> to see whether your query is supported or limited in some way.</p></li>
<li><p>Review query unit tests at: <a rel="noopener noreferrer" target="_blank" href="https://github.com/StevenMMortimer/salesforcer/blob/main/tests/testthat/test-query.R">https://github.com/StevenMMortimer/salesforcer/blob/main/tests/testthat/test-query.R</a>. These unit tests were written to cover a variety of use cases and to track any changes made between newly released versions of the Salesforce API (typically 4 each year). These tests are an excellent source of examples that may be helpful in troubleshooting your own query.</p></li>
<li>
<p>Roll up your sleeves and dive into the source code for the {salesforcer} package. The main scripts to review are:</p>
<ul>
<li><p><a rel="noopener noreferrer" target="_blank" href="https://github.com/StevenMMortimer/salesforcer/blob/main/R/query.R">https://github.com/StevenMMortimer/salesforcer/blob/main/R/query.R</a></p></li>
<li><p><a rel="noopener noreferrer" target="_blank" href="https://github.com/StevenMMortimer/salesforcer/blob/main/R/utils-query.R">https://github.com/StevenMMortimer/salesforcer/blob/main/R/utils-query.R</a></p></li>
</ul>
</li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Steven M. Mortimer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: 'c7d5ea1103660127418415a82a24fc3d',
    indexName: 'salesforcer',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
